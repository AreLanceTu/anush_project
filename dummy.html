<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Profile</title>

    <style>
      :root {
        --bg: #f4f6fb;
        --card: #ffffff;
        --text: #101828;
        --muted: #667085;
        --line: #eaecf0;
        --soft: #f8fafc;
        --soft2: #f2f4f7;
        --accent: #ff5a7a;
        --accentSoft: #ffe8ee;
        --shadow: 0 18px 55px rgba(16, 24, 40, 0.12);
        --radius: 22px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        background: linear-gradient(180deg, #ffffff 0%, var(--bg) 55%);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      }

      .app {
        padding: 10px 10px;
        display: grid;
        grid-template-columns: 228px minmax(0, 1fr) 228px;
        gap: 16px;
        align-items: start;
      }

      .sidebar {
        justify-self: start;
      }

      .spacer {
        justify-self: end;
      }

      .card {
        background: var(--card);
        border: 1px solid rgba(234, 236, 240, 0.95);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .card.pad {
        padding: 10px;
      }

      .sidebar .card {
        width: 228px;
      }

      .cardTitle {
        font-weight: 900;
        font-size: 14px;
        letter-spacing: 0.2px;
        margin: 4px 2px 12px;
      }

      .meRow {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .meAvatar {
        width: 66px;
        height: 66px;
        border-radius: 18px;
        background: #ffe9ee;
        border: 1px solid rgba(255, 90, 122, 0.28);
        display: grid;
        place-items: center;
        overflow: hidden;
        flex: 0 0 auto;
      }

      .meAvatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
      }

      .meAvatar.has-photo img {
        display: block;
      }

      .meAvatar .phText {
        color: rgba(16, 24, 40, 0.55);
        font-weight: 800;
        font-size: 11px;
        letter-spacing: 0.2px;
      }

      .meMeta {
        min-width: 0;
      }

      .meMeta .nm {
        font-weight: 800;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .meMeta .un {
        margin-top: 2px;
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .btn {
        width: 100%;
        margin-top: 10px;
        border: 1px solid rgba(234, 236, 240, 0.95);
        background: #fff;
        color: #1d2939;
        font-weight: 800;
        font-size: 12.5px;
        padding: 9px 10px;
        border-radius: 14px;
        cursor: pointer;
      }

      .btn:hover {
        background: #fbfcfe;
      }

      .thumbs {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      .thumb {
        width: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 14px;
        border: 1px solid rgba(234, 236, 240, 0.95);
        background: var(--soft2);
        overflow: hidden;
        display: none;
      }

      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
      }

      .thumb.has-photo img {
        display: block;
      }

      .main {
        width: 100%;
        justify-self: center;
        max-width: 880px;
      }

      .profileCard {
        margin-top: 0;
      }

      .topbar {
        padding: 12px 12px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .topbar .ttl {
        font-weight: 800;
        font-size: 18px;
        letter-spacing: 0.2px;
      }

      .editBtn {
        border: 1px solid rgba(234, 236, 240, 0.95);
        background: #fff;
        color: #1d2939;
        font-weight: 800;
        font-size: 12.5px;
        padding: 9px 12px;
        border-radius: 14px;
        cursor: pointer;
      }

      .editBtn.primary {
        border-color: rgba(255, 90, 122, 0.32);
        background: rgba(255, 90, 122, 0.10);
        color: #b42318;
      }

      .editBtnWrap {
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .header {
        padding: 2px 12px 10px;
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #ffe9ee;
        border: 1px solid rgba(255, 90, 122, 0.28);
        display: grid;
        place-items: center;
        overflow: hidden;
        flex: 0 0 auto;
      }

      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
      }

      .avatar.has-photo img {
        display: block;
      }

      .avatar svg {
        width: 28px;
        height: 28px;
        color: #101828;
        opacity: 0.9;
      }

      .nameLine {
        min-width: 0;
        flex: 1;
      }

      .nameLine .name {
        font-weight: 700;
        font-size: 20px;
        letter-spacing: 0.2px;
        display: flex;
        gap: 4px;
        align-items: baseline;
        min-width: 0;
      }

      .nameInput,
      .userInput {
        border: none;
        background: transparent;
        outline: none;
        font: inherit;
        color: inherit;
        padding: 0;
        margin: 0;
        min-width: 0;
      }

      .nameInput {
        font-weight: 700;
        font-size: 20px;
        width: min(420px, 55vw);
      }

      .userInput {
        font-weight: 700;
        font-size: 20px;
        width: min(200px, 30vw);
      }

      .rowInput {
        border: none;
        background: transparent;
        outline: none;
        font: inherit;
        color: inherit;
        padding: 0;
        margin: 0;
        width: min(360px, 46vw);
      }

      .dobInput {
        border: none;
        background: transparent;
        outline: none;
        font: inherit;
        color: inherit;
        padding: 0;
        margin: 0;
      }

      .dobInput[disabled] {
        color: #101828;
        opacity: 1;
        -webkit-text-fill-color: #101828;
      }

      .subRow {
        margin-top: 6px;
        color: var(--muted);
        font-size: 13px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      .subRow b {
        color: #101828;
        font-weight: 600;
      }

      .flag {
        width: 22px;
        height: 22px;
        border-radius: 8px;
        display: grid;
        place-items: center;
        border: 1px solid rgba(234, 236, 240, 0.95);
        background: #fff;
        font-size: 12px;
      }

      .zodiacRow {
        margin-top: 10px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 14px;
        background: #f8fafc;
        border: 1px solid rgba(234, 236, 240, 0.95);
        color: #344054;
        font-weight: 650;
        font-size: 12px;
      }

      .divider {
        height: 1px;
        background: rgba(234, 236, 240, 0.95);
      }


      .likes {
        margin: 10px 12px;
        background: #ffecef;
        border: 1px solid rgba(255, 90, 122, 0.25);
        border-radius: 16px;
        padding: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
      }

      .likesLeft {
        display: inline-flex;
        align-items: center;
        gap: 12px;
      }

      .heartBox {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        background: rgba(255, 90, 122, 0.15);
        display: grid;
        place-items: center;
      }

      .heartBox svg {
        width: 20px;
        height: 20px;
        fill: var(--accent);
      }

      .likesMeta {
        line-height: 1.1;
      }

      .likesMeta .num {
        font-weight: 800;
        font-size: 18px;
        color: #101828;
      }

      .likesMeta .txt {
        font-size: 12px;
        color: var(--muted);
      }

      .popBadge {
        background: rgba(255, 90, 122, 0.18);
        color: #b42318;
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 800;
        font-size: 12.5px;
        white-space: nowrap;
      }

      .rows {
        padding: 6px 12px 12px;
        display: grid;
        gap: 8px;
      }

      .aboutRow {
        border-radius: 16px;
        border: 1px solid rgba(234, 236, 240, 0.95);
        background: #fff;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .aboutRow .k {
        color: var(--muted);
        font-size: 13px;
      }

      .aboutBox {
        width: 100%;
        min-height: 84px;
        resize: none;
        border: 1px solid rgba(234, 236, 240, 0.95);
        background: #f8fafc;
        border-radius: 14px;
        padding: 10px;
        font: inherit;
        color: #101828;
        line-height: 1.35;
        outline: none;
      }

      .row {
        border-radius: 16px;
        border: 1px solid rgba(234, 236, 240, 0.95);
        background: #fff;
        padding: 10px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .row.disabled {
        background: #f2f4f7;
      }

      .row .l {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
      }

      .row .k {
        color: var(--muted);
        font-size: 13px;
      }

      .row .v {
        font-weight: 700;
        font-size: 16px;
        color: #101828;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .row.disabled .v {
        color: rgba(16, 24, 40, 0.8);
      }

      .row .r {
        flex: 0 0 auto;
        display: grid;
        place-items: center;
        width: 34px;
        height: 34px;
        border-radius: 12px;
      }

      .row svg {
        width: 18px;
        height: 18px;
        color: rgba(102, 112, 133, 0.95);
      }

      .hint {
        padding: 0 12px 12px;
        color: var(--muted);
        font-size: 12px;
      }

      .isEditing .nameInput,
      .isEditing .userInput {
        background: rgba(255, 90, 122, 0.10);
        border-radius: 12px;
        padding: 6px 10px;
      }

      .isEditing .rowInput,
      .isEditing .aboutBox {
        background: rgba(255, 90, 122, 0.08);
        border-color: rgba(255, 90, 122, 0.25);
      }

      .isEditing .dobInput {
        background: rgba(255, 90, 122, 0.10);
        border-radius: 12px;
        padding: 4px 8px;
      }

      @media (max-width: 940px) {
        .app {
          grid-template-columns: 1fr;
        }
        .main {
          max-width: 760px;
        }

        .sidebar .card {
          width: auto;
        }


        .spacer {
          display: none;
        }
      }

      @media (min-width: 720px) {
        .rows {
          grid-template-columns: 1fr 1fr;
        }

        .aboutRow {
          grid-column: 1 / -1;
        }
      }
    </style>
  </head>

  <body>
    <div class="app">
      <aside class="sidebar">
        <section class="card pad" aria-label="My Account">
          <div class="cardTitle">My Account</div>
          <div class="meRow">
            <div class="meAvatar" id="sidebarAvatar">
              <img id="sidebarAvatarImg" alt="" />
              <span class="phText" id="sidebarAvatarPh">NO PHOTO</span>
            </div>
            <div class="meMeta">
              <div class="nm" id="sidebarName">‚Äî</div>
              <div class="un" id="sidebarUsername">‚Äî</div>
            </div>
          </div>

          <button class="btn" id="uploadBtn" type="button">Upload profile photo</button>
          <input id="dpFileInput" type="file" accept="image/*" style="display:none;" />

          <div class="thumbs" id="thumbsWrap" aria-label="Gallery thumbnails">
            <div class="thumb" id="thumb1"><img id="thumb1Img" alt="" /></div>
            <div class="thumb" id="thumb2"><img id="thumb2Img" alt="" /></div>
          </div>
        </section>
      </aside>

      <main class="main">
        <section class="card profileCard" id="profileCard" aria-label="Edit Profile">
          <div class="topbar">
            <div class="ttl">Edit Profile</div>
            <div class="editBtnWrap">
              <button class="editBtn" id="cancelBtn" type="button" style="display:none;">Cancel</button>
              <button class="editBtn primary" id="editBtn" type="button">Edit Profile</button>
            </div>
          </div>

          <div class="header">
            <div class="avatar" id="mainAvatar">
              <img id="mainAvatarImg" alt="" />
              <svg id="mainAvatarIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="12" cy="8" r="4" />
                <path d="M4 20c2-4 14-4 16 0" />
              </svg>
            </div>

            <div class="nameLine">
              <div class="name" aria-label="Name and username">
                <input id="nameInput" class="nameInput" type="text" value="" readonly />
                <input id="usernameInput" class="userInput" type="text" value="" readonly />
              </div>

              <div class="subRow">
                <span>Gender:&nbsp; <b id="genderText">‚Äî</b></span>
                <span>
                  Birthday:&nbsp;
                  <b id="dobText">‚Äî</b>
                  <input id="dobInput" class="dobInput" type="date" value="" style="display:none;" disabled />
                </span>
                <span style="display:inline-flex;align-items:center;gap:10px;">
                  <span class="flag" id="countryFlag" aria-hidden="true">üåç</span>
                  <b id="countryText">‚Äî</b>
                </span>
              </div>

              <div class="zodiacRow" aria-label="Zodiac">
                <span id="zodiacText">Zodiac: ‚Äî</span>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="likes" aria-label="Likes section">
            <div class="likesLeft">
              <div class="heartBox" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path
                    d="M12 21s-7.2-4.6-9.6-9C.6 8.7 2.4 5.7 5.7 5.2 7.6 5 9.2 6 10 7.2c.8-1.2 2.4-2.2 4.3-2 3.3.5 5.1 3.5 3.3 6.8-2.4 4.4-9.6 9-9.6 9z"
                  />
                </svg>
              </div>
              <div class="likesMeta">
                <div class="num" id="likesCount">0</div>
                <div class="txt">People liked your profile</div>
              </div>
            </div>
            <div class="popBadge">Popularity</div>
          </div>

          <div class="rows">
            <div class="row disabled">
              <div class="l">
                <div class="k">Religion</div>
                <div class="v" id="religionText">‚Äî</div>
              </div>
              <div class="r" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 11V8a5 5 0 0 1 10 0v3" />
                  <rect x="5" y="11" width="14" height="10" rx="2" />
                </svg>
              </div>
            </div>

            <div class="row disabled">
              <div class="l">
                <div class="k">Marital Status</div>
                <div class="v" id="maritalText">‚Äî</div>
              </div>
              <div class="r" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 11V8a5 5 0 0 1 10 0v3" />
                  <rect x="5" y="11" width="14" height="10" rx="2" />
                </svg>
              </div>
            </div>

            <div class="row">
              <div class="l">
                <div class="k">Company</div>
                <input id="companyInput" class="rowInput v" type="text" value="" readonly />
              </div>
              <div class="r" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6" />
                </svg>
              </div>
            </div>

            <div class="row disabled">
              <div class="l">
                <div class="k">Job / Profession</div>
                <div class="v" id="jobText">‚Äî</div>
              </div>
              <div class="r" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 11V8a5 5 0 0 1 10 0v3" />
                  <rect x="5" y="11" width="14" height="10" rx="2" />
                </svg>
              </div>
            </div>

            <div class="row disabled">
              <div class="l">
                <div class="k">Qualification</div>
                <div class="v" id="qualificationText">‚Äî</div>
              </div>
              <div class="r" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 11V8a5 5 0 0 1 10 0v3" />
                  <rect x="5" y="11" width="14" height="10" rx="2" />
                </svg>
              </div>
            </div>

            <div class="aboutRow">
              <div class="k">Yourself</div>
              <textarea id="yourselfText" class="aboutBox" readonly placeholder="Write something about yourself..."></textarea>
            </div>
          </div>

          <div class="hint">Locked fields are read-only. Editable fields show an arrow.</div>
        </section>
      </main>

      <div class="spacer" aria-hidden="true"></div>
    </div>

    <script>
      (function () {
        const KEYS = {
          dp: 'dpUrl',
          photo1: 'photo1Url',
          photo2: 'photo2Url',
          likes: 'vivah_profileLikes',
          firebaseUser: 'firebaseUser',
          username: 'vivah_username',
          name: 'vivah_name',
          dob: 'vivah_dob',
          country: 'vivah_country',
          religion: 'vivah_religion',
          marital: 'vivah_marital',
          company: 'vivah_company',
          job: 'vivah_job',
          qualification: 'vivah_qualification',
          gender: 'vivah_gender',
          yourself: 'vivah_yourself',
        };

        const el = {
          sidebarAvatar: document.getElementById('sidebarAvatar'),
          sidebarAvatarImg: document.getElementById('sidebarAvatarImg'),
          sidebarAvatarPh: document.getElementById('sidebarAvatarPh'),
          sidebarName: document.getElementById('sidebarName'),
          sidebarUsername: document.getElementById('sidebarUsername'),
          uploadBtn: document.getElementById('uploadBtn'),
          dpFileInput: document.getElementById('dpFileInput'),

          thumbsWrap: document.getElementById('thumbsWrap'),
          thumb1: document.getElementById('thumb1'),
          thumb1Img: document.getElementById('thumb1Img'),
          thumb2: document.getElementById('thumb2'),
          thumb2Img: document.getElementById('thumb2Img'),

          profileCard: document.getElementById('profileCard'),
          mainAvatar: document.getElementById('mainAvatar'),
          mainAvatarImg: document.getElementById('mainAvatarImg'),
          mainAvatarIcon: document.getElementById('mainAvatarIcon'),
          nameInput: document.getElementById('nameInput'),
          usernameInput: document.getElementById('usernameInput'),
          genderText: document.getElementById('genderText'),
          dobText: document.getElementById('dobText'),
          dobInput: document.getElementById('dobInput'),
          countryFlag: document.getElementById('countryFlag'),
          countryText: document.getElementById('countryText'),
          zodiacText: document.getElementById('zodiacText'),
          likesCount: document.getElementById('likesCount'),
          religionText: document.getElementById('religionText'),
          maritalText: document.getElementById('maritalText'),
          companyInput: document.getElementById('companyInput'),
          jobText: document.getElementById('jobText'),
          qualificationText: document.getElementById('qualificationText'),
          yourselfText: document.getElementById('yourselfText'),
          editBtn: document.getElementById('editBtn'),
          cancelBtn: document.getElementById('cancelBtn'),
        };

        function safeJsonParse(value) {
          try {
            return JSON.parse(value);
          } catch {
            return null;
          }
        }

        function getDisplayName() {
          const fromLs = localStorage.getItem(KEYS.name);
          if (fromLs) return fromLs;
          const fb = safeJsonParse(localStorage.getItem(KEYS.firebaseUser));
          return fb?.displayName || 'Minu';
        }

        function getUsername() {
          const u = localStorage.getItem(KEYS.username);
          if (u) return '@' + u.replace(/^@+/, '');
          const fb = safeJsonParse(localStorage.getItem(KEYS.firebaseUser));
          const email = fb?.email || '';
          if (email.includes('@')) return '@' + email.split('@')[0];
          return '@minu';
        }

        function setAvatar(container, imgEl, placeholderEl, url) {
          if (!container || !imgEl || !placeholderEl) return;
          if (url) {
            imgEl.src = url;
            container.classList.add('has-photo');
            placeholderEl.style.display = 'none';
          } else {
            imgEl.removeAttribute('src');
            container.classList.remove('has-photo');
            placeholderEl.style.display = 'block';
          }
        }

        function setThumb(thumbEl, imgEl, url) {
          if (!thumbEl || !imgEl) return;
          if (url) {
            imgEl.src = url;
            thumbEl.classList.add('has-photo');
            thumbEl.style.display = 'block';
            imgEl.style.display = 'block';
          } else {
            imgEl.removeAttribute('src');
            thumbEl.classList.remove('has-photo');
            thumbEl.style.display = 'none';
            imgEl.style.display = 'none';
          }
        }

        function toFlagEmoji(iso2) {
          if (!iso2 || typeof iso2 !== 'string' || iso2.length !== 2) return 'üåç';
          const code = iso2.toUpperCase();
          const a = 0x1f1e6;
          const first = code.charCodeAt(0) - 65 + a;
          const second = code.charCodeAt(1) - 65 + a;
          return String.fromCodePoint(first, second);
        }

        async function resolveCountryFlag(countryName) {
          const name = (countryName || '').trim();
          if (!name) return 'üåç';

          const cacheKey = 'vivah_countryCodeCache_v2';
          const cache = safeJsonParse(localStorage.getItem(cacheKey)) || {};
          if (cache[name]) return toFlagEmoji(cache[name]);

          try {
            let res = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(name)}?fullText=true`);
            if (!res.ok) res = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(name)}`);
            if (!res.ok) throw new Error('country lookup failed');
            const data = await res.json();
            const code = data?.[0]?.cca2;
            if (code && typeof code === 'string') {
              cache[name] = code.toUpperCase();
              localStorage.setItem(cacheKey, JSON.stringify(cache));
              return toFlagEmoji(code);
            }
          } catch {
            // ignore
          }
          return 'üåç';
        }

        function zodiacFromDob(dobValue) {
          if (!dobValue || typeof dobValue !== 'string') return '';
          const parts = dobValue.split('-');
          if (parts.length !== 3) return '';
          const month = Number(parts[1]);
          const day = Number(parts[2]);
          if (!month || !day) return '';

          const zodiac = [
            { name: 'Capricorn', emoji: '‚ôë', from: [12, 22], to: [1, 19] },
            { name: 'Aquarius', emoji: '‚ôí', from: [1, 20], to: [2, 18] },
            { name: 'Pisces', emoji: '‚ôì', from: [2, 19], to: [3, 20] },
            { name: 'Aries', emoji: '‚ôà', from: [3, 21], to: [4, 19] },
            { name: 'Taurus', emoji: '‚ôâ', from: [4, 20], to: [5, 20] },
            { name: 'Gemini', emoji: '‚ôä', from: [5, 21], to: [6, 20] },
            { name: 'Cancer', emoji: '‚ôã', from: [6, 21], to: [7, 22] },
            { name: 'Leo', emoji: '‚ôå', from: [7, 23], to: [8, 22] },
            { name: 'Virgo', emoji: '‚ôç', from: [8, 23], to: [9, 22] },
            { name: 'Libra', emoji: '‚ôé', from: [9, 23], to: [10, 22] },
            { name: 'Scorpio', emoji: '‚ôè', from: [10, 23], to: [11, 21] },
            { name: 'Sagittarius', emoji: '‚ôê', from: [11, 22], to: [12, 21] },
          ];

          function isOnOrAfter(m, d, fm, fd) {
            return m > fm || (m === fm && d >= fd);
          }
          function isOnOrBefore(m, d, tm, td) {
            return m < tm || (m === tm && d <= td);
          }

          for (const z of zodiac) {
            const [fm, fd] = z.from;
            const [tm, td] = z.to;
            if (fm <= tm) {
              if (isOnOrAfter(month, day, fm, fd) && isOnOrBefore(month, day, tm, td)) return `${z.name} ${z.emoji}`;
            } else {
              if (isOnOrAfter(month, day, fm, fd) || isOnOrBefore(month, day, tm, td)) return `${z.name} ${z.emoji}`;
            }
          }
          return '';
        }

        function setHoroscopeFromDob(dob) {
          const z = zodiacFromDob(dob);
          el.zodiacText.textContent = z ? `Zodiac: ${z}` : 'Zodiac: ‚Äî';
        }

        function load() {
          const dp = localStorage.getItem(KEYS.dp);
          const photo1 = localStorage.getItem(KEYS.photo1);
          const photo2 = localStorage.getItem(KEYS.photo2);

          el.sidebarName.textContent = getDisplayName();
          el.sidebarUsername.textContent = getUsername();
          setAvatar(el.sidebarAvatar, el.sidebarAvatarImg, el.sidebarAvatarPh, dp);

          setThumb(el.thumb1, el.thumb1Img, photo1);
          setThumb(el.thumb2, el.thumb2Img, photo2);

          if (el.thumbsWrap) {
            const hasAnyThumb = Boolean(photo1 || photo2);
            el.thumbsWrap.style.display = hasAnyThumb ? 'grid' : 'none';
          }

          setAvatar(el.mainAvatar, el.mainAvatarImg, el.mainAvatarIcon, dp);

          el.nameInput.value = getDisplayName();
          el.usernameInput.value = getUsername();

          const likes = Number(localStorage.getItem(KEYS.likes) || '0');
          el.likesCount.textContent = Number.isFinite(likes) ? String(likes) : '0';

          el.religionText.textContent = localStorage.getItem(KEYS.religion) || '‚Äî';
          el.maritalText.textContent = localStorage.getItem(KEYS.marital) || '‚Äî';
          el.companyInput.value = localStorage.getItem(KEYS.company) || '';
          el.jobText.textContent = localStorage.getItem(KEYS.job) || '‚Äî';
          el.qualificationText.textContent = localStorage.getItem(KEYS.qualification) || '‚Äî';

          el.yourselfText.value = localStorage.getItem(KEYS.yourself) || '';

          const gender = localStorage.getItem(KEYS.gender) || '‚Äî';
          el.genderText.textContent = gender;

          const dob = localStorage.getItem(KEYS.dob) || '';
          el.dobText.textContent = dob || '‚Äî';
          if (el.dobInput) {
            const ok = /^\d{4}-\d{2}-\d{2}$/.test(dob);
            el.dobInput.value = ok ? dob : '';
          }

          const country = localStorage.getItem(KEYS.country) || localStorage.getItem('livingIn') || '';
          el.countryText.textContent = country;

          setHoroscopeFromDob(dob);

          resolveCountryFlag(country)
            .then((flag) => {
              el.countryFlag.textContent = flag;
            })
            .catch(() => {
              el.countryFlag.textContent = 'üåç';
            });
        }

        let editing = false;
        let snapshot = { name: '', username: '', company: '', yourself: '', dob: '' };

        function setEditing(next) {
          editing = Boolean(next);
          el.profileCard.classList.toggle('isEditing', editing);
          el.cancelBtn.style.display = editing ? 'inline-flex' : 'none';
          el.editBtn.textContent = editing ? 'Save' : 'Edit Profile';
          el.nameInput.readOnly = !editing;
          el.usernameInput.readOnly = !editing;
          el.companyInput.readOnly = !editing;
          el.yourselfText.readOnly = !editing;
          if (el.dobInput) {
            el.dobInput.disabled = !editing;
            el.dobInput.style.display = editing ? 'inline-block' : 'none';
          }
          if (el.dobText) {
            el.dobText.style.display = editing ? 'none' : 'inline';
          }
          if (editing) {
            el.nameInput.focus();
            el.nameInput.select();
          }
        }

        function beginEdit() {
          snapshot = {
            name: el.nameInput.value,
            username: el.usernameInput.value,
            company: el.companyInput.value,
            yourself: el.yourselfText.value,
            dob: el.dobInput?.value || localStorage.getItem(KEYS.dob) || '',
          };
          setEditing(true);
        }

        function cancelEdit() {
          el.nameInput.value = snapshot.name;
          el.usernameInput.value = snapshot.username;
          el.companyInput.value = snapshot.company;
          el.yourselfText.value = snapshot.yourself;
          if (el.dobInput) el.dobInput.value = snapshot.dob;
          setEditing(false);
          setHoroscopeFromDob(snapshot.dob);
        }

        function saveEdit() {
          const nextName = (el.nameInput.value || '').trim();
          const nextUsername = (el.usernameInput.value || '').trim();
          if (!nextName || !nextUsername) {
            alert('Name and Username cannot be empty');
            return;
          }
          localStorage.setItem(KEYS.name, nextName);
          localStorage.setItem(KEYS.username, nextUsername.replace(/^@+/, ''));

          const nextCompany = (el.companyInput.value || '').trim();
          localStorage.setItem(KEYS.company, nextCompany);

          const nextYourself = (el.yourselfText.value || '').trim();
          localStorage.setItem(KEYS.yourself, nextYourself);

          const nextDob = (el.dobInput?.value || '').trim();
          if (nextDob) localStorage.setItem(KEYS.dob, nextDob);

          setEditing(false);
          load();
        }

        function wire() {
          el.editBtn.addEventListener('click', () => {
            if (!editing) beginEdit();
            else saveEdit();
          });
          el.cancelBtn.addEventListener('click', cancelEdit);

          document.addEventListener('keydown', (e) => {
            if (!editing) return;
            if (e.key === 'Escape') cancelEdit();
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
              e.preventDefault();
              saveEdit();
              return;
            }

            if (e.key === 'Enter') {
              const target = e.target;
              const tag = (target?.tagName || '').toLowerCase();
              const type = (target?.getAttribute?.('type') || '').toLowerCase();
              if (tag === 'textarea') return;
              if (tag === 'input' && type === 'date') return;
              e.preventDefault();
              saveEdit();
            }
          });

          el.dobInput?.addEventListener('change', () => {
            if (!editing) return;
            setHoroscopeFromDob(el.dobInput.value);
          });

          el.uploadBtn.addEventListener('click', () => {
            el.dpFileInput?.click();
          });

          el.dpFileInput?.addEventListener('change', () => {
            const file = el.dpFileInput.files?.[0];
            if (!file) return;

            // Store small images as data URL for preview; large files should be uploaded via Upload.html.
            const maxBytes = 1_500_000; // ~1.5MB
            if (file.size > maxBytes) {
              alert('This image is too large for direct preview. Please upload using Upload.html.');
              el.dpFileInput.value = '';
              return;
            }

            const reader = new FileReader();
            reader.onload = () => {
              const dataUrl = typeof reader.result === 'string' ? reader.result : '';
              if (!dataUrl) return;
              localStorage.setItem(KEYS.dp, dataUrl);
              el.dpFileInput.value = '';
              load();
            };
            reader.readAsDataURL(file);
          });
        }

        window.addEventListener('storage', (e) => {
          if (!e) return;
          if ([KEYS.dp, KEYS.photo1, KEYS.photo2, KEYS.likes, KEYS.dob, KEYS.country, KEYS.company, KEYS.yourself, KEYS.job].includes(e.key)) load();
        });

        load();
        wire();
      })();
    </script>
  </body>
</html>
